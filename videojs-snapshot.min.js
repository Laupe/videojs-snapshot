/*! videojs-snapshot 2016-04-17 */
function snapshot(a){function b(){var a=j.getBoundingClientRect(),b=y.el().width/a.width,c=y.el().height/a.height;h=Math.max(Math.max(b,c),1),v.el().innerHTML=Math.round(1/h*100)/100+"x"}function c(a){var b=m.el().querySelector(".vjs-tool-active");b.classList.remove("vjs-tool-active"),a.target.classList.add("vjs-tool-active"),p=a.target.dataset.value,C.hide()}function d(a){var b=document.createElement("canvas");b.width=y.el().width,b.height=y.el().height;var c=b.getContext("2d");c.drawImage(w.el(),0,0),c.drawImage(y.el(),0,0),window.open(b.toDataURL(a))}function e(a,b,c,d,e,f,h,j){var k=new videojs.Component(i,{el:videojs.Component.prototype.createEl("canvas",{})}),l=i.el().getBoundingClientRect();k.el().style.maxWidth=l.width+"px",k.el().style.maxHeight=l.height+"px",k.el().width=e,k.el().height=f;var m=k.el().getContext("2d");return m.drawImage(h.el(),a,b,c,d,0,0,e,f),g.removeChild(h),g.addChild(k),m.lineCap=j.lineCap,m.strokeStyle=j.strokeStyle,m.lineWidth=j.lineWidth,[k,m]}function f(){E&&(E=!1,"rect"==p?(z.drawImage(A.el(),h*A.el().offsetLeft,h*A.el().offsetTop,h*B.canvas.width,h*B.canvas.height),A.hide()):"text"==p&&(i.el().blur(),D.el().focus()))}var g,h,i=this,j=i.el().querySelector("video");i.snap=function(){i.pause(),i.el().blur(),i.controlBar.hide(),m.show(),l.show(),y.el().width=j.videoWidth,y.el().height=j.videoHeight,z.strokeStyle=n.el().value,z.lineWidth=o.el().value/2,z.lineCap="round",b(),w.el().width=j.videoWidth,w.el().height=j.videoHeight,x.drawImage(j,0,0);var a=j.getBoundingClientRect();y.el().style.maxWidth=a.width+"px",y.el().style.maxHeight=a.height+"px",w.el().style.maxWidth=a.width+"px",w.el().style.maxHeight=a.height+"px"};var k=i.controlBar.addChild("button");k.addClass("vjs-snapshot-button"),k.el().title="Take snapshot",k.on("click",i.snap);var l=i.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl(null,{className:"vjs-canvas-parent"})})),m=i.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl(null,{className:"vjs-control-bar vjs-drawing-ctrl"})}));m.hide();var n=m.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl("input",{className:"vjs-control",type:"color",value:"#df4b26",title:"color"})}));n.on("change",function(a){z.strokeStyle=n.el().value});var o=m.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl("input",{className:"vjs-control",type:"number",value:"10",title:"line width, text size, ..."})}));o.on("keydown",function(a){a.stopPropagation()}),o.on("change",function(a){z.lineWidth=o.el().value/2});var p="brush";videojs.ToolButton=videojs.Button.extend({init:function(a,b){videojs.Button.call(this,a,b),this.addClass("vjs-drawing-"+b.tool),this.el().dataset.value=b.tool,this.el().title=b.title,this.on("click",c)}});var q=m.addChild(new videojs.ToolButton(i,{tool:"brush",title:"freehand drawing"}));q.addClass("vjs-tool-active");var r=(m.addChild(new videojs.ToolButton(i,{tool:"rect",title:"draw rectangle from top left to bottom right"})),m.addChild(new videojs.ToolButton(i,{tool:"crop",title:"select area and click selection to crop"})),m.addChild(new videojs.ToolButton(i,{tool:"text",title:"select area, type message and then click somewhere else"})),m.addChild(new videojs.ToolButton(i,{tool:"eraser",title:"erase drawing in clicked location"})),m.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl(null,{className:"vjs-control vjs-drawing-scaler",title:"scale image"})})));r.on("click",function(a){var c=y.el().width,d=y.el().height,f=window.prompt("Current image size is "+c+"x"+d+" . New width?",c);if(f=parseInt(f,10),!isNaN(f)){var g=f/c,h=g*c|0,i=g*d|0,j=e(0,0,c,d,h,i,w,x);w=j[0],x=j[1],j=e(0,0,c,d,h,i,y,z),y=j[0],z=j[1],b()}});var s=m.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl(null,{className:"vjs-control vjs-button",innerHTML:"JPEG",title:"open new tab with jpeg image"})}));s.on("click",function(){d("image/jpeg")});var t=m.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl(null,{className:"vjs-control vjs-button",innerHTML:"PNG",title:"open new tab with png image"})}));t.on("click",function(){d("image/png")});var u=m.addChild("button");u.addClass("vjs-drawing-close"),u.el().title="close screenshot and return to video",u.on("click",function(){C.hide(),l.hide(),m.hide(),i.controlBar.show(),i.el().focus()});var v=m.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl(null,{className:"vjs-scale",innerHTML:"1",title:"scale factor"})}));g=l.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl(null,{className:"vjs-canvas-container"})}));var w=g.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl("canvas",{})})),x=w.el().getContext("2d"),y=g.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl("canvas",{})})),z=y.el().getContext("2d"),A=g.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl("canvas",{})}));A.el().style.zIndex="1";var B=A.el().getContext("2d"),C=g.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl("div",{innerHTML:"crop"})}));C.el().style.display="flex",C.on("mousedown",function(a){var c=h*C.el().offsetLeft|0,d=h*C.el().offsetTop|0,f=h*C.el().offsetWidth|0,g=h*C.el().offsetHeight|0,i=e(c,d,f,g,f,g,w,x);w=i[0],x=i[1],i=e(c,d,f,g,f,g,y,z),y=i[0],z=i[1],b(),C.hide(),a.stopPropagation()});var D=g.addChild(new videojs.Component(i,{el:videojs.Component.prototype.createEl("textarea",{})}));D.on("keydown",function(a){a.stopPropagation()}),D.on("blur",function(a){z.fillStyle=n.el().value,z.font=h*o.el().value*2+"px sans-serif",z.textBaseline="top",z.fillText(D.el().value,h*D.el().offsetLeft+h,h*D.el().offsetTop+h),D.hide(),D.el().value=""}),l.hide(),A.hide(),C.hide(),D.hide();var E=!1;g.on("mousedown",function(a){E=!0;var b=g.el().getBoundingClientRect(),c=a.clientX-b.left,d=a.clientY-b.top;switch(p){case"brush":c*=h,d*=h,z.beginPath(),z.moveTo(c-1,d),z.lineTo(c,d),z.stroke();break;case"rect":A.el().width=0,A.el().height=0,A.el().style.left=c+"px",A.el().style.top=d+"px",A.show();break;case"crop":C.el().style.width=0,C.el().style.height=0,C.el().style.left=c+"px",C.el().style.top=d+"px",C.el().style.border="1px dashed "+n.el().value,C.el().style.color=n.el().value,C.show();break;case"text":D.hasClass("vjs-hidden")&&(D.el().style.width=0,D.el().style.height=0,D.el().style.left=c+"px",D.el().style.top=d+"px",D.el().style.border="1px dashed "+n.el().value,D.el().style.color=n.el().value,D.el().style.font=2*o.el().value+"px sans-serif",D.show());break;case"eraser":var e=o.el().value;z.clearRect(h*c-e/2,h*d-e/2,e,e)}}),g.on("mousemove",function(a){if(E){var b=g.el().getBoundingClientRect(),c=a.clientX-b.left,d=a.clientY-b.top;switch(p){case"brush":z.lineTo(h*c,h*d),z.stroke();break;case"rect":B.clearRect(0,0,B.canvas.width,B.canvas.height),A.el().width=c-A.el().offsetLeft,A.el().height=d-A.el().offsetTop,B.strokeStyle=n.el().value,B.lineWidth=o.el().value/h,B.strokeRect(0,0,B.canvas.width,B.canvas.height);break;case"crop":C.el().style.width=c-C.el().offsetLeft+"px",C.el().style.height=d-C.el().offsetTop+"px";break;case"text":D.el().style.width=c-D.el().offsetLeft+"px",D.el().style.height=d-D.el().offsetTop+"px";break;case"eraser":var e=o.el().value;z.clearRect(h*c-e/2,h*d-e/2,e,e)}a.preventDefault()}}),g.on("mouseup",f),g.on("mouseleave",f)}videojs.plugin("snapshot",snapshot);